function nt(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Pe={exports:{}},h={};/**
 * @license React
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var U=Symbol.for("react.element"),st=Symbol.for("react.portal"),rt=Symbol.for("react.fragment"),it=Symbol.for("react.strict_mode"),ot=Symbol.for("react.profiler"),at=Symbol.for("react.provider"),ut=Symbol.for("react.context"),ct=Symbol.for("react.forward_ref"),ht=Symbol.for("react.suspense"),lt=Symbol.for("react.memo"),dt=Symbol.for("react.lazy"),me=Symbol.iterator;function ft(n){return n===null||typeof n!="object"?null:(n=me&&n[me]||n["@@iterator"],typeof n=="function"?n:null)}var xe={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},Qe=Object.assign,Le={};function Q(n,e,t){this.props=n,this.context=e,this.refs=Le,this.updater=t||xe}Q.prototype.isReactComponent={};Q.prototype.setState=function(n,e){if(typeof n!="object"&&typeof n!="function"&&n!=null)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,n,e,"setState")};Q.prototype.forceUpdate=function(n){this.updater.enqueueForceUpdate(this,n,"forceUpdate")};function Ve(){}Ve.prototype=Q.prototype;function le(n,e,t){this.props=n,this.context=e,this.refs=Le,this.updater=t||xe}var de=le.prototype=new Ve;de.constructor=le;Qe(de,Q.prototype);de.isPureReactComponent=!0;var we=Array.isArray,Ne=Object.prototype.hasOwnProperty,fe={current:null},Fe={key:!0,ref:!0,__self:!0,__source:!0};function Be(n,e,t){var s,r={},i=null,o=null;if(e!=null)for(s in e.ref!==void 0&&(o=e.ref),e.key!==void 0&&(i=""+e.key),e)Ne.call(e,s)&&!Fe.hasOwnProperty(s)&&(r[s]=e[s]);var a=arguments.length-2;if(a===1)r.children=t;else if(1<a){for(var u=Array(a),c=0;c<a;c++)u[c]=arguments[c+2];r.children=u}if(n&&n.defaultProps)for(s in a=n.defaultProps,a)r[s]===void 0&&(r[s]=a[s]);return{$$typeof:U,type:n,key:i,ref:o,props:r,_owner:fe.current}}function gt(n,e){return{$$typeof:U,type:n.type,key:e,ref:n.ref,props:n.props,_owner:n._owner}}function ge(n){return typeof n=="object"&&n!==null&&n.$$typeof===U}function yt(n){var e={"=":"=0",":":"=2"};return"$"+n.replace(/[=:]/g,function(t){return e[t]})}var Se=/\/+/g;function ee(n,e){return typeof n=="object"&&n!==null&&n.key!=null?yt(""+n.key):e.toString(36)}function H(n,e,t,s,r){var i=typeof n;(i==="undefined"||i==="boolean")&&(n=null);var o=!1;if(n===null)o=!0;else switch(i){case"string":case"number":o=!0;break;case"object":switch(n.$$typeof){case U:case st:o=!0}}if(o)return o=n,r=r(o),n=s===""?"."+ee(o,0):s,we(r)?(t="",n!=null&&(t=n.replace(Se,"$&/")+"/"),H(r,e,t,"",function(c){return c})):r!=null&&(ge(r)&&(r=gt(r,t+(!r.key||o&&o.key===r.key?"":(""+r.key).replace(Se,"$&/")+"/")+n)),e.push(r)),1;if(o=0,s=s===""?".":s+":",we(n))for(var a=0;a<n.length;a++){i=n[a];var u=s+ee(i,a);o+=H(i,e,t,u,r)}else if(u=ft(n),typeof u=="function")for(n=u.call(n),a=0;!(i=n.next()).done;)i=i.value,u=s+ee(i,a++),o+=H(i,e,t,u,r);else if(i==="object")throw e=String(n),Error("Objects are not valid as a React child (found: "+(e==="[object Object]"?"object with keys {"+Object.keys(n).join(", ")+"}":e)+"). If you meant to render a collection of children, use an array instead.");return o}function j(n,e,t){if(n==null)return n;var s=[],r=0;return H(n,s,"","",function(i){return e.call(t,i,r++)}),s}function pt(n){if(n._status===-1){var e=n._result;e=e(),e.then(function(t){(n._status===0||n._status===-1)&&(n._status=1,n._result=t)},function(t){(n._status===0||n._status===-1)&&(n._status=2,n._result=t)}),n._status===-1&&(n._status=0,n._result=e)}if(n._status===1)return n._result.default;throw n._result}var m={current:null},z={transition:null},mt={ReactCurrentDispatcher:m,ReactCurrentBatchConfig:z,ReactCurrentOwner:fe};function De(){throw Error("act(...) is not supported in production builds of React.")}h.Children={map:j,forEach:function(n,e,t){j(n,function(){e.apply(this,arguments)},t)},count:function(n){var e=0;return j(n,function(){e++}),e},toArray:function(n){return j(n,function(e){return e})||[]},only:function(n){if(!ge(n))throw Error("React.Children.only expected to receive a single React element child.");return n}};h.Component=Q;h.Fragment=rt;h.Profiler=ot;h.PureComponent=le;h.StrictMode=it;h.Suspense=ht;h.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mt;h.act=De;h.cloneElement=function(n,e,t){if(n==null)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+n+".");var s=Qe({},n.props),r=n.key,i=n.ref,o=n._owner;if(e!=null){if(e.ref!==void 0&&(i=e.ref,o=fe.current),e.key!==void 0&&(r=""+e.key),n.type&&n.type.defaultProps)var a=n.type.defaultProps;for(u in e)Ne.call(e,u)&&!Fe.hasOwnProperty(u)&&(s[u]=e[u]===void 0&&a!==void 0?a[u]:e[u])}var u=arguments.length-2;if(u===1)s.children=t;else if(1<u){a=Array(u);for(var c=0;c<u;c++)a[c]=arguments[c+2];s.children=a}return{$$typeof:U,type:n.type,key:r,ref:i,props:s,_owner:o}};h.createContext=function(n){return n={$$typeof:ut,_currentValue:n,_currentValue2:n,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null},n.Provider={$$typeof:at,_context:n},n.Consumer=n};h.createElement=Be;h.createFactory=function(n){var e=Be.bind(null,n);return e.type=n,e};h.createRef=function(){return{current:null}};h.forwardRef=function(n){return{$$typeof:ct,render:n}};h.isValidElement=ge;h.lazy=function(n){return{$$typeof:dt,_payload:{_status:-1,_result:n},_init:pt}};h.memo=function(n,e){return{$$typeof:lt,type:n,compare:e===void 0?null:e}};h.startTransition=function(n){var e=z.transition;z.transition={};try{n()}finally{z.transition=e}};h.unstable_act=De;h.useCallback=function(n,e){return m.current.useCallback(n,e)};h.useContext=function(n){return m.current.useContext(n)};h.useDebugValue=function(){};h.useDeferredValue=function(n){return m.current.useDeferredValue(n)};h.useEffect=function(n,e){return m.current.useEffect(n,e)};h.useId=function(){return m.current.useId()};h.useImperativeHandle=function(n,e,t){return m.current.useImperativeHandle(n,e,t)};h.useInsertionEffect=function(n,e){return m.current.useInsertionEffect(n,e)};h.useLayoutEffect=function(n,e){return m.current.useLayoutEffect(n,e)};h.useMemo=function(n,e){return m.current.useMemo(n,e)};h.useReducer=function(n,e,t){return m.current.useReducer(n,e,t)};h.useRef=function(n){return m.current.useRef(n)};h.useState=function(n){return m.current.useState(n)};h.useSyncExternalStore=function(n,e,t){return m.current.useSyncExternalStore(n,e,t)};h.useTransition=function(){return m.current.useTransition()};h.version="18.3.1";Pe.exports=h;var wt=Pe.exports;const Ue=nt(wt),be="1.32.0";var k=[],b=[],St=Uint8Array,te="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var M=0,bt=te.length;M<bt;++M)k[M]=te[M],b[te.charCodeAt(M)]=M;b[45]=62;b[95]=63;function vt(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var s=t===e?0:4-t%4;return[t,s]}function kt(n,e,t){return(e+t)*3/4-t}function F(n){var e,t=vt(n),s=t[0],r=t[1],i=new St(kt(n,s,r)),o=0,a=r>0?s-4:s,u;for(u=0;u<a;u+=4)e=b[n.charCodeAt(u)]<<18|b[n.charCodeAt(u+1)]<<12|b[n.charCodeAt(u+2)]<<6|b[n.charCodeAt(u+3)],i[o++]=e>>16&255,i[o++]=e>>8&255,i[o++]=e&255;return r===2&&(e=b[n.charCodeAt(u)]<<2|b[n.charCodeAt(u+1)]>>4,i[o++]=e&255),r===1&&(e=b[n.charCodeAt(u)]<<10|b[n.charCodeAt(u+1)]<<4|b[n.charCodeAt(u+2)]>>2,i[o++]=e>>8&255,i[o++]=e&255),i}function Tt(n){return k[n>>18&63]+k[n>>12&63]+k[n>>6&63]+k[n&63]}function Rt(n,e,t){for(var s,r=[],i=e;i<t;i+=3)s=(n[i]<<16&16711680)+(n[i+1]<<8&65280)+(n[i+2]&255),r.push(Tt(s));return r.join("")}function B(n){for(var e,t=n.length,s=t%3,r=[],i=16383,o=0,a=t-s;o<a;o+=i)r.push(Rt(n,o,o+i>a?a:o+i));return s===1?(e=n[t-1],r.push(k[e>>2]+k[e<<4&63]+"==")):s===2&&(e=(n[t-2]<<8)+n[t-1],r.push(k[e>>10]+k[e>>4&63]+k[e<<2&63]+"=")),r.join("")}function R(n){if(n===void 0)return{};if(!je(n))throw new Error(`The arguments to a Convex function must be an object. Received: ${n}`);return n}function Ct(n){if(typeof n>"u")throw new Error("Client created with undefined deployment address. If you used an environment variable, check that it's set.");if(typeof n!="string")throw new Error(`Invalid deployment address: found ${n}".`);if(!(n.startsWith("http:")||n.startsWith("https:")))throw new Error(`Invalid deployment address: Must start with "https://" or "http://". Found "${n}".`);try{new URL(n)}catch{throw new Error(`Invalid deployment address: "${n}" is not a valid URL. If you believe this URL is correct, use the \`skipConvexDeploymentUrlCheck\` option to bypass this.`)}if(n.endsWith(".convex.site"))throw new Error(`Invalid deployment address: "${n}" ends with .convex.site, which is used for HTTP Actions. Convex deployment URLs typically end with .convex.cloud? If you believe this URL is correct, use the \`skipConvexDeploymentUrlCheck\` option to bypass this.`)}function je(n){var r;const e=typeof n=="object",t=Object.getPrototypeOf(n),s=t===null||t===Object.prototype||((r=t==null?void 0:t.constructor)==null?void 0:r.name)==="Object";return e&&s}const We=!0,P=BigInt("-9223372036854775808"),ye=BigInt("9223372036854775807"),ae=BigInt("0"),_t=BigInt("8"),qt=BigInt("256");function Ke(n){return Number.isNaN(n)||!Number.isFinite(n)||Object.is(n,-0)}function At(n){n<ae&&(n-=P+P);let e=n.toString(16);e.length%2===1&&(e="0"+e);const t=new Uint8Array(new ArrayBuffer(8));let s=0;for(const r of e.match(/.{2}/g).reverse())t.set([parseInt(r,16)],s++),n>>=_t;return B(t)}function It(n){const e=F(n);if(e.byteLength!==8)throw new Error(`Received ${e.byteLength} bytes, expected 8 for $integer`);let t=ae,s=ae;for(const r of e)t+=BigInt(r)*qt**s,s++;return t>ye&&(t+=P+P),t}function $t(n){if(n<P||ye<n)throw new Error(`BigInt ${n} does not fit into a 64-bit signed integer.`);const e=new ArrayBuffer(8);return new DataView(e).setBigInt64(0,n,!0),B(new Uint8Array(e))}function Mt(n){const e=F(n);if(e.byteLength!==8)throw new Error(`Received ${e.byteLength} bytes, expected 8 for $integer`);return new DataView(e.buffer).getBigInt64(0,!0)}const Et=DataView.prototype.setBigInt64?$t:At,Ot=DataView.prototype.getBigInt64?Mt:It,ve=1024;function He(n){if(n.length>ve)throw new Error(`Field name ${n} exceeds maximum field name length ${ve}.`);if(n.startsWith("$"))throw new Error(`Field name ${n} starts with a '$', which is reserved.`);for(let e=0;e<n.length;e+=1){const t=n.charCodeAt(e);if(t<32||t>=127)throw new Error(`Field name ${n} has invalid character '${n[e]}': Field names can only contain non-control ASCII characters`)}}function x(n){if(n===null||typeof n=="boolean"||typeof n=="number"||typeof n=="string")return n;if(Array.isArray(n))return n.map(s=>x(s));if(typeof n!="object")throw new Error(`Unexpected type of ${n}`);const e=Object.entries(n);if(e.length===1){const s=e[0][0];if(s==="$bytes"){if(typeof n.$bytes!="string")throw new Error(`Malformed $bytes field on ${n}`);return F(n.$bytes).buffer}if(s==="$integer"){if(typeof n.$integer!="string")throw new Error(`Malformed $integer field on ${n}`);return Ot(n.$integer)}if(s==="$float"){if(typeof n.$float!="string")throw new Error(`Malformed $float field on ${n}`);const r=F(n.$float);if(r.byteLength!==8)throw new Error(`Received ${r.byteLength} bytes, expected 8 for $float`);const o=new DataView(r.buffer).getFloat64(0,We);if(!Ke(o))throw new Error(`Float ${o} should be encoded as a number`);return o}if(s==="$set")throw new Error("Received a Set which is no longer supported as a Convex type.");if(s==="$map")throw new Error("Received a Map which is no longer supported as a Convex type.")}const t={};for(const[s,r]of Object.entries(n))He(s),t[s]=x(r);return t}const ke=16384;function V(n){const e=JSON.stringify(n,(t,s)=>s===void 0?"undefined":typeof s=="bigint"?`${s.toString()}n`:s);if(e.length>ke){const t="[...truncated]";let s=ke-t.length;const r=e.codePointAt(s-1);return r!==void 0&&r>65535&&(s-=1),e.substring(0,s)+t}return e}function ue(n,e,t,s){var o;if(n===void 0){const a=t&&` (present at path ${t} in original object ${V(e)})`;throw new Error(`undefined is not a valid Convex value${a}. To learn about Convex's supported types, see https://docs.convex.dev/using/types.`)}if(n===null)return n;if(typeof n=="bigint"){if(n<P||ye<n)throw new Error(`BigInt ${n} does not fit into a 64-bit signed integer.`);return{$integer:Et(n)}}if(typeof n=="number")if(Ke(n)){const a=new ArrayBuffer(8);return new DataView(a).setFloat64(0,n,We),{$float:B(new Uint8Array(a))}}else return n;if(typeof n=="boolean"||typeof n=="string")return n;if(n instanceof ArrayBuffer)return{$bytes:B(new Uint8Array(n))};if(Array.isArray(n))return n.map((a,u)=>ue(a,e,t+`[${u}]`));if(n instanceof Set)throw new Error(ne(t,"Set",[...n],e));if(n instanceof Map)throw new Error(ne(t,"Map",[...n],e));if(!je(n)){const a=(o=n==null?void 0:n.constructor)==null?void 0:o.name,u=a?`${a} `:"";throw new Error(ne(t,u,n,e))}const r={},i=Object.entries(n);i.sort(([a,u],[c,y])=>a===c?0:a<c?-1:1);for(const[a,u]of i)u!==void 0&&(He(a),r[a]=ue(u,e,t+`.${a}`));return r}function ne(n,e,t,s){return n?`${e}${V(t)} is not a supported Convex type (present at path ${n} in original object ${V(s)}). To learn about Convex's supported types, see https://docs.convex.dev/using/types.`:`${e}${V(t)} is not a supported Convex type.`}function I(n){return ue(n,n,"")}var Pt=Object.defineProperty,xt=(n,e,t)=>e in n?Pt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,se=(n,e,t)=>xt(n,typeof e!="symbol"?e+"":e,t),Te,Re;const Qt=Symbol.for("ConvexError");class ce extends(Re=Error,Te=Qt,Re){constructor(e){super(typeof e=="string"?e:V(e)),se(this,"name","ConvexError"),se(this,"data"),se(this,Te,!0),this.data=e}}const ze=()=>Array.from({length:4},()=>0);ze();ze();var Lt=Object.defineProperty,Vt=(n,e,t)=>e in n?Lt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Ce=(n,e,t)=>Vt(n,typeof e!="symbol"?e+"":e,t);const Nt="color:rgb(0, 145, 255)";function Je(n){switch(n){case"query":return"Q";case"mutation":return"M";case"action":return"A";case"any":return"?"}}class Ge{constructor(e){Ce(this,"_onLogLineFuncs"),Ce(this,"_verbose"),this._onLogLineFuncs={},this._verbose=e.verbose}addLogLineListener(e){let t=Math.random().toString(36).substring(2,15);for(let s=0;s<10&&this._onLogLineFuncs[t]!==void 0;s++)t=Math.random().toString(36).substring(2,15);return this._onLogLineFuncs[t]=e,()=>{delete this._onLogLineFuncs[t]}}logVerbose(...e){if(this._verbose)for(const t of Object.values(this._onLogLineFuncs))t("debug",`${new Date().toISOString()}`,...e)}log(...e){for(const t of Object.values(this._onLogLineFuncs))t("info",...e)}warn(...e){for(const t of Object.values(this._onLogLineFuncs))t("warn",...e)}error(...e){for(const t of Object.values(this._onLogLineFuncs))t("error",...e)}}function Xe(n){const e=new Ge(n);return e.addLogLineListener((t,...s)=>{switch(t){case"debug":console.debug(...s);break;case"info":console.log(...s);break;case"warn":console.warn(...s);break;case"error":console.error(...s);break;default:console.log(...s)}}),e}function Ye(n){return new Ge(n)}function G(n,e,t,s,r){const i=Je(t);if(typeof r=="object"&&(r=`ConvexError ${JSON.stringify(r.errorData,null,2)}`),e==="info"){const o=r.match(/^\[.*?\] /);if(o===null){n.error(`[CONVEX ${i}(${s})] Could not parse console.log`);return}const a=r.slice(1,o[0].length-2),u=r.slice(o[0].length);n.log(`%c[CONVEX ${i}(${s})] [${a}]`,Nt,u)}else n.error(`[CONVEX ${i}(${s})] ${r}`)}function Ft(n,e){const t=`[CONVEX FATAL ERROR] ${e}`;return n.error(t),new Error(t)}function O(n,e,t){return`[CONVEX ${Je(n)}(${e})] ${t.errorMessage}
  Called by client`}function he(n,e){return e.data=n.errorData,e}function $(n){const e=n.split(":");let t,s;return e.length===1?(t=e[0],s="default"):(t=e.slice(0,e.length-1).join(":"),s=e[e.length-1]),t.endsWith(".js")&&(t=t.slice(0,-3)),`${t}:${s}`}function A(n,e){return JSON.stringify({udfPath:$(n),args:I(e)})}function _e(n,e,t){const{initialNumItems:s,id:r}=t;return JSON.stringify({type:"paginated",udfPath:$(n),args:I(e),options:I({initialNumItems:s,id:r})})}var Bt=Object.defineProperty,Dt=(n,e,t)=>e in n?Bt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,v=(n,e,t)=>Dt(n,typeof e!="symbol"?e+"":e,t);class Ut{constructor(){v(this,"nextQueryId"),v(this,"querySetVersion"),v(this,"querySet"),v(this,"queryIdToToken"),v(this,"identityVersion"),v(this,"auth"),v(this,"outstandingQueriesOlderThanRestart"),v(this,"outstandingAuthOlderThanRestart"),v(this,"paused"),v(this,"pendingQuerySetModifications"),this.nextQueryId=0,this.querySetVersion=0,this.identityVersion=0,this.querySet=new Map,this.queryIdToToken=new Map,this.outstandingQueriesOlderThanRestart=new Set,this.outstandingAuthOlderThanRestart=!1,this.paused=!1,this.pendingQuerySetModifications=new Map}hasSyncedPastLastReconnect(){return this.outstandingQueriesOlderThanRestart.size===0&&!this.outstandingAuthOlderThanRestart}markAuthCompletion(){this.outstandingAuthOlderThanRestart=!1}subscribe(e,t,s,r){const i=$(e),o=A(i,t),a=this.querySet.get(o);if(a!==void 0)return a.numSubscribers+=1,{queryToken:o,modification:null,unsubscribe:()=>this.removeSubscriber(o)};{const u=this.nextQueryId++,c={id:u,canonicalizedUdfPath:i,args:t,numSubscribers:1,journal:s,componentPath:r};this.querySet.set(o,c),this.queryIdToToken.set(u,o);const y=this.querySetVersion,p=this.querySetVersion+1,C={type:"Add",queryId:u,udfPath:i,args:[I(t)],journal:s,componentPath:r};return this.paused?this.pendingQuerySetModifications.set(u,C):this.querySetVersion=p,{queryToken:o,modification:{type:"ModifyQuerySet",baseVersion:y,newVersion:p,modifications:[C]},unsubscribe:()=>this.removeSubscriber(o)}}}transition(e){for(const t of e.modifications)switch(t.type){case"QueryUpdated":case"QueryFailed":{this.outstandingQueriesOlderThanRestart.delete(t.queryId);const s=t.journal;if(s!==void 0){const r=this.queryIdToToken.get(t.queryId);r!==void 0&&(this.querySet.get(r).journal=s)}break}case"QueryRemoved":{this.outstandingQueriesOlderThanRestart.delete(t.queryId);break}default:throw new Error(`Invalid modification ${t.type}`)}}queryId(e,t){const s=$(e),r=A(s,t),i=this.querySet.get(r);return i!==void 0?i.id:null}isCurrentOrNewerAuthVersion(e){return e>=this.identityVersion}getAuth(){return this.auth}setAuth(e){this.auth={tokenType:"User",value:e};const t=this.identityVersion;return this.paused||(this.identityVersion=t+1),{type:"Authenticate",baseVersion:t,...this.auth}}setAdminAuth(e,t){const s={tokenType:"Admin",value:e,impersonating:t};this.auth=s;const r=this.identityVersion;return this.paused||(this.identityVersion=r+1),{type:"Authenticate",baseVersion:r,...s}}clearAuth(){this.auth=void 0,this.markAuthCompletion();const e=this.identityVersion;return this.paused||(this.identityVersion=e+1),{type:"Authenticate",tokenType:"None",baseVersion:e}}hasAuth(){return!!this.auth}isNewAuth(e){var t;return((t=this.auth)==null?void 0:t.value)!==e}queryPath(e){const t=this.queryIdToToken.get(e);return t?this.querySet.get(t).canonicalizedUdfPath:null}queryArgs(e){const t=this.queryIdToToken.get(e);return t?this.querySet.get(t).args:null}queryToken(e){return this.queryIdToToken.get(e)??null}queryJournal(e){var t;return(t=this.querySet.get(e))==null?void 0:t.journal}restart(e){this.unpause(),this.outstandingQueriesOlderThanRestart.clear();const t=[];for(const i of this.querySet.values()){const o={type:"Add",queryId:i.id,udfPath:i.canonicalizedUdfPath,args:[I(i.args)],journal:i.journal,componentPath:i.componentPath};t.push(o),e.has(i.id)||this.outstandingQueriesOlderThanRestart.add(i.id)}this.querySetVersion=1;const s={type:"ModifyQuerySet",baseVersion:0,newVersion:1,modifications:t};if(!this.auth)return this.identityVersion=0,[s,void 0];this.outstandingAuthOlderThanRestart=!0;const r={type:"Authenticate",baseVersion:0,...this.auth};return this.identityVersion=1,[s,r]}pause(){this.paused=!0}resume(){const e=this.pendingQuerySetModifications.size>0?{type:"ModifyQuerySet",baseVersion:this.querySetVersion,newVersion:++this.querySetVersion,modifications:Array.from(this.pendingQuerySetModifications.values())}:void 0,t=this.auth!==void 0?{type:"Authenticate",baseVersion:this.identityVersion++,...this.auth}:void 0;return this.unpause(),[e,t]}unpause(){this.paused=!1,this.pendingQuerySetModifications.clear()}removeSubscriber(e){const t=this.querySet.get(e);if(t.numSubscribers>1)return t.numSubscribers-=1,null;{this.querySet.delete(e),this.queryIdToToken.delete(t.id),this.outstandingQueriesOlderThanRestart.delete(t.id);const s=this.querySetVersion,r=this.querySetVersion+1,i={type:"Remove",queryId:t.id};return this.paused?this.pendingQuerySetModifications.has(t.id)?this.pendingQuerySetModifications.delete(t.id):this.pendingQuerySetModifications.set(t.id,i):this.querySetVersion=r,{type:"ModifyQuerySet",baseVersion:s,newVersion:r,modifications:[i]}}}}var jt=Object.defineProperty,Wt=(n,e,t)=>e in n?jt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,W=(n,e,t)=>Wt(n,typeof e!="symbol"?e+"":e,t);class Kt{constructor(e,t){this.logger=e,this.markConnectionStateDirty=t,W(this,"inflightRequests"),W(this,"requestsOlderThanRestart"),W(this,"inflightMutationsCount",0),W(this,"inflightActionsCount",0),this.inflightRequests=new Map,this.requestsOlderThanRestart=new Set}request(e,t){const s=new Promise(r=>{const i=t?"Requested":"NotSent";this.inflightRequests.set(e.requestId,{message:e,status:{status:i,requestedAt:new Date,onResult:r}}),e.type==="Mutation"?this.inflightMutationsCount++:e.type==="Action"&&this.inflightActionsCount++});return this.markConnectionStateDirty(),s}onResponse(e){const t=this.inflightRequests.get(e.requestId);if(t===void 0||t.status.status==="Completed")return null;const s=t.message.type==="Mutation"?"mutation":"action",r=t.message.udfPath;for(const u of e.logLines)G(this.logger,"info",s,r,u);const i=t.status;let o,a;if(e.success)o={success:!0,logLines:e.logLines,value:x(e.result)},a=()=>i.onResult(o);else{const u=e.result,{errorData:c}=e;G(this.logger,"error",s,r,u),o={success:!1,errorMessage:u,errorData:c!==void 0?x(c):void 0,logLines:e.logLines},a=()=>i.onResult(o)}return e.type==="ActionResponse"||!e.success?(a(),this.inflightRequests.delete(e.requestId),this.requestsOlderThanRestart.delete(e.requestId),t.message.type==="Action"?this.inflightActionsCount--:t.message.type==="Mutation"&&this.inflightMutationsCount--,this.markConnectionStateDirty(),{requestId:e.requestId,result:o}):(t.status={status:"Completed",result:o,ts:e.ts,onResolve:a},null)}removeCompleted(e){const t=new Map;for(const[s,r]of this.inflightRequests.entries()){const i=r.status;i.status==="Completed"&&i.ts.lessThanOrEqual(e)&&(i.onResolve(),t.set(s,i.result),r.message.type==="Mutation"?this.inflightMutationsCount--:r.message.type==="Action"&&this.inflightActionsCount--,this.inflightRequests.delete(s),this.requestsOlderThanRestart.delete(s))}return t.size>0&&this.markConnectionStateDirty(),t}restart(){this.requestsOlderThanRestart=new Set(this.inflightRequests.keys());const e=[];for(const[t,s]of this.inflightRequests){if(s.status.status==="NotSent"){s.status.status="Requested",e.push(s.message);continue}if(s.message.type==="Mutation")e.push(s.message);else if(s.message.type==="Action"){if(this.inflightRequests.delete(t),this.requestsOlderThanRestart.delete(t),this.inflightActionsCount--,s.status.status==="Completed")throw new Error("Action should never be in 'Completed' state");s.status.onResult({success:!1,errorMessage:"Connection lost while action was in flight",logLines:[]})}}return this.markConnectionStateDirty(),e}resume(){const e=[];for(const[,t]of this.inflightRequests)if(t.status.status==="NotSent"){t.status.status="Requested",e.push(t.message);continue}return e}hasIncompleteRequests(){for(const e of this.inflightRequests.values())if(e.status.status==="Requested")return!0;return!1}hasInflightRequests(){return this.inflightRequests.size>0}hasSyncedPastLastReconnect(){return this.requestsOlderThanRestart.size===0}timeOfOldestInflightRequest(){if(this.inflightRequests.size===0)return null;let e=Date.now();for(const t of this.inflightRequests.values())t.status.status!=="Completed"&&t.status.requestedAt.getTime()<e&&(e=t.status.requestedAt.getTime());return new Date(e)}inflightMutations(){return this.inflightMutationsCount}inflightActions(){return this.inflightActionsCount}}const X=Symbol.for("functionName"),Ht=Symbol.for("toReferencePath");function zt(n){return n[Ht]??null}function Jt(n){return n.startsWith("function://")}function Gt(n){let e;if(typeof n=="string")Jt(n)?e={functionHandle:n}:e={name:n};else if(n[X])e={name:n[X]};else{const t=zt(n);if(!t)throw new Error(`${n} is not a functionReference`);e={reference:t}}return e}function q(n){const e=Gt(n);if(e.name===void 0)throw e.functionHandle!==void 0?new Error(`Expected function reference like "api.file.func" or "internal.file.func", but received function handle ${e.functionHandle}`):e.reference!==void 0?new Error(`Expected function reference in the current component like "api.file.func" or "internal.file.func", but received reference ${e.reference}`):new Error(`Expected function reference like "api.file.func" or "internal.file.func", but received ${JSON.stringify(e)}`);if(typeof n=="string")return n;const t=n[X];if(!t)throw new Error(`${n} is not a functionReference`);return t}function Ze(n=[]){const e={get(t,s){if(typeof s=="string"){const r=[...n,s];return Ze(r)}else if(s===X){if(n.length<2){const o=["api",...n].join(".");throw new Error(`API path is expected to be of the form \`api.moduleName.functionName\`. Found: \`${o}\``)}const r=n.slice(0,-1).join("/"),i=n[n.length-1];return i==="default"?r:r+":"+i}else return s===Symbol.toStringTag?"FunctionReference":void 0}};return new Proxy({},e)}Ze();var Xt=Object.defineProperty,Yt=(n,e,t)=>e in n?Xt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Y=(n,e,t)=>Yt(n,typeof e!="symbol"?e+"":e,t);class D{constructor(e){Y(this,"queryResults"),Y(this,"modifiedQueries"),this.queryResults=e,this.modifiedQueries=[]}getQuery(e,...t){const s=R(t[0]),r=q(e),i=this.queryResults.get(A(r,s));if(i!==void 0)return D.queryValue(i.result)}getAllQueries(e){const t=[],s=q(e);for(const r of this.queryResults.values())r.udfPath===$(s)&&t.push({args:r.args,value:D.queryValue(r.result)});return t}setQuery(e,t,s){const r=R(t),i=q(e),o=A(i,r);let a;s===void 0?a=void 0:a={success:!0,value:s,logLines:[]};const u={udfPath:i,args:r,result:a};this.queryResults.set(o,u),this.modifiedQueries.push(o)}static queryValue(e){if(e!==void 0)return e.success?e.value:void 0}}class Zt{constructor(){Y(this,"queryResults"),Y(this,"optimisticUpdates"),this.queryResults=new Map,this.optimisticUpdates=[]}ingestQueryResultsFromServer(e,t){this.optimisticUpdates=this.optimisticUpdates.filter(o=>!t.has(o.mutationId));const s=this.queryResults;this.queryResults=new Map(e);const r=new D(this.queryResults);for(const o of this.optimisticUpdates)o.update(r);const i=[];for(const[o,a]of this.queryResults){const u=s.get(o);(u===void 0||u.result!==a.result)&&i.push(o)}return i}applyOptimisticUpdate(e,t){this.optimisticUpdates.push({update:e,mutationId:t});const s=new D(this.queryResults);return e(s),s.modifiedQueries}rawQueryResult(e){const t=this.queryResults.get(e);if(t!==void 0)return t.result}queryResult(e){const t=this.queryResults.get(e);if(t===void 0)return;const s=t.result;if(s!==void 0){if(s.success)return s.value;throw s.errorData!==void 0?he(s,new ce(O("query",t.udfPath,s))):new Error(O("query",t.udfPath,s))}}hasQueryResult(e){return this.queryResults.get(e)!==void 0}queryLogs(e){var s;const t=this.queryResults.get(e);return(s=t==null?void 0:t.result)==null?void 0:s.logLines}}var en=Object.defineProperty,tn=(n,e,t)=>e in n?en(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,re=(n,e,t)=>tn(n,typeof e!="symbol"?e+"":e,t);class w{constructor(e,t){re(this,"low"),re(this,"high"),re(this,"__isUnsignedLong__"),this.low=e|0,this.high=t|0,this.__isUnsignedLong__=!0}static isLong(e){return(e&&e.__isUnsignedLong__)===!0}static fromBytesLE(e){return new w(e[0]|e[1]<<8|e[2]<<16|e[3]<<24,e[4]|e[5]<<8|e[6]<<16|e[7]<<24)}toBytesLE(){const e=this.high,t=this.low;return[t&255,t>>>8&255,t>>>16&255,t>>>24,e&255,e>>>8&255,e>>>16&255,e>>>24]}static fromNumber(e){return isNaN(e)||e<0?qe:e>=nn?sn:new w(e%N|0,e/N|0)}toString(){return(BigInt(this.high)*BigInt(N)+BigInt(this.low)).toString()}equals(e){return w.isLong(e)||(e=w.fromValue(e)),this.high>>>31===1&&e.high>>>31===1?!1:this.high===e.high&&this.low===e.low}notEquals(e){return!this.equals(e)}comp(e){return w.isLong(e)||(e=w.fromValue(e)),this.equals(e)?0:e.high>>>0>this.high>>>0||e.high===this.high&&e.low>>>0>this.low>>>0?-1:1}lessThanOrEqual(e){return this.comp(e)<=0}static fromValue(e){return typeof e=="number"?w.fromNumber(e):new w(e.low,e.high)}}const qe=new w(0,0),Ae=65536,N=Ae*Ae,nn=N*N,sn=new w(-1,-1);var rn=Object.defineProperty,on=(n,e,t)=>e in n?rn(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,K=(n,e,t)=>on(n,typeof e!="symbol"?e+"":e,t);class Ie{constructor(e,t){K(this,"version"),K(this,"remoteQuerySet"),K(this,"queryPath"),K(this,"logger"),this.version={querySet:0,ts:w.fromNumber(0),identity:0},this.remoteQuerySet=new Map,this.queryPath=e,this.logger=t}transition(e){const t=e.startVersion;if(this.version.querySet!==t.querySet||this.version.ts.notEquals(t.ts)||this.version.identity!==t.identity)throw new Error(`Invalid start version: ${t.ts.toString()}:${t.querySet}:${t.identity}, transitioning from ${this.version.ts.toString()}:${this.version.querySet}:${this.version.identity}`);for(const s of e.modifications)switch(s.type){case"QueryUpdated":{const r=this.queryPath(s.queryId);if(r)for(const o of s.logLines)G(this.logger,"info","query",r,o);const i=x(s.value??null);this.remoteQuerySet.set(s.queryId,{success:!0,value:i,logLines:s.logLines});break}case"QueryFailed":{const r=this.queryPath(s.queryId);if(r)for(const o of s.logLines)G(this.logger,"info","query",r,o);const{errorData:i}=s;this.remoteQuerySet.set(s.queryId,{success:!1,errorMessage:s.errorMessage,errorData:i!==void 0?x(i):void 0,logLines:s.logLines});break}case"QueryRemoved":{this.remoteQuerySet.delete(s.queryId);break}default:throw new Error(`Invalid modification ${s.type}`)}this.version=e.endVersion}remoteQueryResults(){return this.remoteQuerySet}timestamp(){return this.version.ts}}function ie(n){const e=F(n);return w.fromBytesLE(Array.from(e))}function an(n){const e=new Uint8Array(n.toBytesLE());return B(e)}function $e(n){switch(n.type){case"FatalError":case"AuthError":case"ActionResponse":case"TransitionChunk":case"Ping":return{...n};case"MutationResponse":return n.success?{...n,ts:ie(n.ts)}:{...n};case"Transition":return{...n,startVersion:{...n.startVersion,ts:ie(n.startVersion.ts)},endVersion:{...n.endVersion,ts:ie(n.endVersion.ts)}}}}function un(n){switch(n.type){case"Authenticate":case"ModifyQuerySet":case"Mutation":case"Action":case"Event":return{...n};case"Connect":return n.maxObservedTimestamp!==void 0?{...n,maxObservedTimestamp:an(n.maxObservedTimestamp)}:{...n,maxObservedTimestamp:void 0}}}var cn=Object.defineProperty,hn=(n,e,t)=>e in n?cn(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,f=(n,e,t)=>hn(n,typeof e!="symbol"?e+"":e,t);const ln=1e3,dn=1001,fn=1005,gn=4040;let J;function E(){return J===void 0&&(J=Date.now()),typeof performance>"u"||!performance.now?Date.now():Math.round(J+performance.now())}function Me(){return`t=${Math.round((E()-J)/100)/10}s`}const et={InternalServerError:{timeout:1e3},SubscriptionsWorkerFullError:{timeout:3e3},TooManyConcurrentRequests:{timeout:3e3},CommitterFullError:{timeout:3e3},AwsTooManyRequestsException:{timeout:3e3},ExecuteFullError:{timeout:3e3},SystemTimeoutError:{timeout:3e3},ExpiredInQueue:{timeout:3e3},VectorIndexesUnavailable:{timeout:1e3},SearchIndexesUnavailable:{timeout:1e3},TableSummariesUnavailable:{timeout:1e3},VectorIndexTooLarge:{timeout:3e3},SearchIndexTooLarge:{timeout:3e3},TooManyWritesInTimePeriod:{timeout:3e3}};function yn(n){if(n===void 0)return"Unknown";for(const e of Object.keys(et))if(n.startsWith(e))return e;return"Unknown"}class pn{constructor(e,t,s,r,i,o){this.markConnectionStateDirty=i,this.debug=o,f(this,"socket"),f(this,"connectionCount"),f(this,"_hasEverConnected",!1),f(this,"lastCloseReason"),f(this,"transitionChunkBuffer",null),f(this,"defaultInitialBackoff"),f(this,"maxBackoff"),f(this,"retries"),f(this,"serverInactivityThreshold"),f(this,"reconnectDueToServerInactivityTimeout"),f(this,"scheduledReconnect",null),f(this,"networkOnlineHandler",null),f(this,"pendingNetworkRecoveryInfo",null),f(this,"uri"),f(this,"onOpen"),f(this,"onResume"),f(this,"onMessage"),f(this,"webSocketConstructor"),f(this,"logger"),f(this,"onServerDisconnectError"),this.webSocketConstructor=s,this.socket={state:"disconnected"},this.connectionCount=0,this.lastCloseReason="InitialConnect",this.defaultInitialBackoff=1e3,this.maxBackoff=16e3,this.retries=0,this.serverInactivityThreshold=6e4,this.reconnectDueToServerInactivityTimeout=null,this.uri=e,this.onOpen=t.onOpen,this.onResume=t.onResume,this.onMessage=t.onMessage,this.onServerDisconnectError=t.onServerDisconnectError,this.logger=r,this.setupNetworkListener(),this.connect()}setSocketState(e){this.socket=e,this._logVerbose(`socket state changed: ${this.socket.state}, paused: ${"paused"in this.socket?this.socket.paused:void 0}`),this.markConnectionStateDirty()}setupNetworkListener(){typeof window>"u"||typeof window.addEventListener!="function"||this.networkOnlineHandler===null&&(this.networkOnlineHandler=()=>{this._logVerbose("network online event detected"),this.tryReconnectImmediately()},window.addEventListener("online",this.networkOnlineHandler),this._logVerbose("network online event listener registered"))}cleanupNetworkListener(){this.networkOnlineHandler&&typeof window<"u"&&typeof window.removeEventListener=="function"&&(window.removeEventListener("online",this.networkOnlineHandler),this.networkOnlineHandler=null,this._logVerbose("network online event listener removed"))}assembleTransition(e){if(e.partNumber<0||e.partNumber>=e.totalParts||e.totalParts===0||this.transitionChunkBuffer&&(this.transitionChunkBuffer.totalParts!==e.totalParts||this.transitionChunkBuffer.transitionId!==e.transitionId))throw this.transitionChunkBuffer=null,new Error("Invalid TransitionChunk");if(this.transitionChunkBuffer===null&&(this.transitionChunkBuffer={chunks:[],totalParts:e.totalParts,transitionId:e.transitionId}),e.partNumber!==this.transitionChunkBuffer.chunks.length){const t=this.transitionChunkBuffer.chunks.length;throw this.transitionChunkBuffer=null,new Error(`TransitionChunk received out of order: expected part ${t}, got ${e.partNumber}`)}if(this.transitionChunkBuffer.chunks.push(e.chunk),this.transitionChunkBuffer.chunks.length===e.totalParts){const t=this.transitionChunkBuffer.chunks.join("");this.transitionChunkBuffer=null;const s=$e(JSON.parse(t));if(s.type!=="Transition")throw new Error(`Expected Transition, got ${s.type} after assembling chunks`);return s}return null}connect(){if(this.socket.state==="terminated")return;if(this.socket.state!=="disconnected"&&this.socket.state!=="stopped")throw new Error("Didn't start connection from disconnected state: "+this.socket.state);const e=new this.webSocketConstructor(this.uri);this._logVerbose("constructed WebSocket"),this.setSocketState({state:"connecting",ws:e,paused:"no"}),this.resetServerInactivityTimeout(),e.onopen=()=>{if(this.logger.logVerbose("begin ws.onopen"),this.socket.state!=="connecting")throw new Error("onopen called with socket not in connecting state");if(this.setSocketState({state:"ready",ws:e,paused:this.socket.paused==="yes"?"uninitialized":"no"}),this.resetServerInactivityTimeout(),this.socket.paused==="no"&&(this._hasEverConnected=!0,this.onOpen({connectionCount:this.connectionCount,lastCloseReason:this.lastCloseReason,clientTs:E()})),this.lastCloseReason!=="InitialConnect"&&(this.lastCloseReason?this.logger.log("WebSocket reconnected at",Me(),"after disconnect due to",this.lastCloseReason):this.logger.log("WebSocket reconnected at",Me())),this.connectionCount+=1,this.lastCloseReason=null,this.pendingNetworkRecoveryInfo!==null){const{timeSavedMs:t}=this.pendingNetworkRecoveryInfo;this.pendingNetworkRecoveryInfo=null,this.sendMessage({type:"Event",eventType:"NetworkRecoveryReconnect",event:{timeSavedMs:t}}),this.logger.log(`Network recovery reconnect saved ~${Math.round(t/1e3)}s of waiting`)}},e.onerror=t=>{this.transitionChunkBuffer=null;const s=t.message;s&&this.logger.log(`WebSocket error message: ${s}`)},e.onmessage=t=>{this.resetServerInactivityTimeout();const s=t.data.length;let r=$e(JSON.parse(t.data));if(this._logVerbose(`received ws message with type ${r.type}`),r.type==="Ping")return;if(r.type==="TransitionChunk"){const o=this.assembleTransition(r);if(!o)return;r=o,this._logVerbose(`assembled full ws message of type ${r.type}`)}this.transitionChunkBuffer!==null&&(this.transitionChunkBuffer=null,this.logger.log(`Received unexpected ${r.type} while buffering TransitionChunks`)),r.type==="Transition"&&this.reportLargeTransition({messageLength:s,transition:r}),this.onMessage(r).hasSyncedPastLastReconnect&&(this.retries=0,this.markConnectionStateDirty())},e.onclose=t=>{if(this._logVerbose("begin ws.onclose"),this.transitionChunkBuffer=null,this.lastCloseReason===null&&(this.lastCloseReason=t.reason||`closed with code ${t.code}`),t.code!==ln&&t.code!==dn&&t.code!==fn&&t.code!==gn){let r=`WebSocket closed with code ${t.code}`;t.reason&&(r+=`: ${t.reason}`),this.logger.log(r),this.onServerDisconnectError&&t.reason&&this.onServerDisconnectError(r)}const s=yn(t.reason);this.scheduleReconnect(s)}}socketState(){return this.socket.state}sendMessage(e){const t={type:e.type,...e.type==="Authenticate"&&e.tokenType==="User"?{value:`...${e.value.slice(-7)}`}:{}};if(this.socket.state==="ready"&&this.socket.paused==="no"){const s=un(e),r=JSON.stringify(s);let i=!1;try{this.socket.ws.send(r),i=!0}catch(o){this.logger.log(`Failed to send message on WebSocket, reconnecting: ${o}`),this.closeAndReconnect("FailedToSendMessage")}return this._logVerbose(`${i?"sent":"failed to send"} message with type ${e.type}: ${JSON.stringify(t)}`),!0}return this._logVerbose(`message not sent (socket state: ${this.socket.state}, paused: ${"paused"in this.socket?this.socket.paused:void 0}): ${JSON.stringify(t)}`),!1}resetServerInactivityTimeout(){this.socket.state!=="terminated"&&(this.reconnectDueToServerInactivityTimeout!==null&&(clearTimeout(this.reconnectDueToServerInactivityTimeout),this.reconnectDueToServerInactivityTimeout=null),this.reconnectDueToServerInactivityTimeout=setTimeout(()=>{this.closeAndReconnect("InactiveServer")},this.serverInactivityThreshold))}scheduleReconnect(e){this.scheduledReconnect&&(clearTimeout(this.scheduledReconnect.timeout),this.scheduledReconnect=null),this.socket={state:"disconnected"};const t=this.nextBackoff(e);this.markConnectionStateDirty(),this.logger.log(`Attempting reconnect in ${Math.round(t)}ms`);const s=E(),r=setTimeout(()=>{var i;((i=this.scheduledReconnect)==null?void 0:i.timeout)===r&&(this.scheduledReconnect=null,this.connect())},t);this.scheduledReconnect={timeout:r,scheduledAt:s,backoffMs:t}}closeAndReconnect(e){switch(this._logVerbose(`begin closeAndReconnect with reason ${e}`),this.socket.state){case"disconnected":case"terminated":case"stopped":return;case"connecting":case"ready":{this.lastCloseReason=e,this.close(),this.scheduleReconnect("client");return}default:this.socket}}close(){switch(this.transitionChunkBuffer=null,this.socket.state){case"disconnected":case"terminated":case"stopped":return Promise.resolve();case"connecting":{const e=this.socket.ws;return e.onmessage=t=>{this._logVerbose("Ignoring message received after close")},new Promise(t=>{e.onclose=()=>{this._logVerbose("Closed after connecting"),t()},e.onopen=()=>{this._logVerbose("Opened after connecting"),e.close()}})}case"ready":{this._logVerbose("ws.close called");const e=this.socket.ws;e.onmessage=s=>{this._logVerbose("Ignoring message received after close")};const t=new Promise(s=>{e.onclose=()=>{s()}});return e.close(),t}default:return this.socket,Promise.resolve()}}terminate(){switch(this.reconnectDueToServerInactivityTimeout&&clearTimeout(this.reconnectDueToServerInactivityTimeout),this.scheduledReconnect&&(clearTimeout(this.scheduledReconnect.timeout),this.scheduledReconnect=null),this.cleanupNetworkListener(),this.socket.state){case"terminated":case"stopped":case"disconnected":case"connecting":case"ready":{const e=this.close();return this.setSocketState({state:"terminated"}),e}default:throw this.socket,new Error(`Invalid websocket state: ${this.socket.state}`)}}stop(){switch(this.socket.state){case"terminated":return Promise.resolve();case"connecting":case"stopped":case"disconnected":case"ready":{this.cleanupNetworkListener();const e=this.close();return this.socket={state:"stopped"},e}default:return this.socket,Promise.resolve()}}tryRestart(){switch(this.socket.state){case"stopped":break;case"terminated":case"connecting":case"ready":case"disconnected":this.logger.logVerbose("Restart called without stopping first");return;default:this.socket}this.setupNetworkListener(),this.connect()}pause(){switch(this.socket.state){case"disconnected":case"stopped":case"terminated":return;case"connecting":case"ready":{this.socket={...this.socket,paused:"yes"};return}default:{this.socket;return}}}tryReconnectImmediately(){if(this._logVerbose("tryReconnectImmediately called"),this.socket.state!=="disconnected"){this._logVerbose(`tryReconnectImmediately called but socket state is ${this.socket.state}, no action taken`);return}let e=null;if(this.scheduledReconnect){const t=E()-this.scheduledReconnect.scheduledAt;e=Math.max(0,this.scheduledReconnect.backoffMs-t),this._logVerbose(`would have waited ${Math.round(e)}ms more (backoff was ${Math.round(this.scheduledReconnect.backoffMs)}ms, elapsed ${Math.round(t)}ms)`),clearTimeout(this.scheduledReconnect.timeout),this.scheduledReconnect=null,this._logVerbose("canceled scheduled reconnect")}this.logger.log("Network recovery detected, reconnecting immediately"),this.pendingNetworkRecoveryInfo=e!==null?{timeSavedMs:e}:null,this.connect()}resume(){switch(this.socket.state){case"connecting":this.socket={...this.socket,paused:"no"};return;case"ready":this.socket.paused==="uninitialized"?(this.socket={...this.socket,paused:"no"},this.onOpen({connectionCount:this.connectionCount,lastCloseReason:this.lastCloseReason,clientTs:E()})):this.socket.paused==="yes"&&(this.socket={...this.socket,paused:"no"},this.onResume());return;case"terminated":case"stopped":case"disconnected":return;default:this.socket}this.connect()}connectionState(){return{isConnected:this.socket.state==="ready",hasEverConnected:this._hasEverConnected,connectionCount:this.connectionCount,connectionRetries:this.retries}}_logVerbose(e){this.logger.logVerbose(e)}nextBackoff(e){const s=(e==="client"?100:e==="Unknown"?this.defaultInitialBackoff:et[e].timeout)*Math.pow(2,this.retries);this.retries+=1;const r=Math.min(s,this.maxBackoff),i=r*(Math.random()-.5);return r+i}reportLargeTransition({transition:e,messageLength:t}){if(e.clientClockSkew===void 0||e.serverTs===void 0)return;const s=E()-e.clientClockSkew-e.serverTs/1e6,r=`${Math.round(s)}ms`,i=`${Math.round(t/1e4)/100}MB`,o=t/(s/1e3),a=`${Math.round(o/1e4)/100}MB per second`;this._logVerbose(`received ${i} transition in ${r} at ${a}`),t>2e7?this.logger.log(`received query results totaling more that 20MB (${i}) which will take a long time to download on slower connections`):s>2e4&&this.logger.log(`received query results totaling ${i} which took more than 20s to arrive (${r})`),this.debug&&this.sendMessage({type:"Event",eventType:"ClientReceivedTransition",event:{transitionTransitTime:s,messageLength:t}})}}function mn(){return wn()}function wn(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)})}class L extends Error{}L.prototype.name="InvalidTokenError";function Sn(n){return decodeURIComponent(atob(n).replace(/(.)/g,(e,t)=>{let s=t.charCodeAt(0).toString(16).toUpperCase();return s.length<2&&(s="0"+s),"%"+s}))}function bn(n){let e=n.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return Sn(e)}catch{return atob(e)}}function tt(n,e){if(typeof n!="string")throw new L("Invalid token specified: must be a string");e||(e={});const t=e.header===!0?0:1,s=n.split(".")[t];if(typeof s!="string")throw new L(`Invalid token specified: missing part #${t+1}`);let r;try{r=bn(s)}catch(i){throw new L(`Invalid token specified: invalid base64 for part #${t+1} (${i.message})`)}try{return JSON.parse(r)}catch(i){throw new L(`Invalid token specified: invalid json for part #${t+1} (${i.message})`)}}var vn=Object.defineProperty,kn=(n,e,t)=>e in n?vn(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,S=(n,e,t)=>kn(n,typeof e!="symbol"?e+"":e,t);const Tn=20*24*60*60*1e3,Ee=2;class Rn{constructor(e,t,s){S(this,"authState",{state:"noAuth"}),S(this,"configVersion",0),S(this,"syncState"),S(this,"authenticate"),S(this,"stopSocket"),S(this,"tryRestartSocket"),S(this,"pauseSocket"),S(this,"resumeSocket"),S(this,"clearAuth"),S(this,"logger"),S(this,"refreshTokenLeewaySeconds"),S(this,"tokenConfirmationAttempts",0),this.syncState=e,this.authenticate=t.authenticate,this.stopSocket=t.stopSocket,this.tryRestartSocket=t.tryRestartSocket,this.pauseSocket=t.pauseSocket,this.resumeSocket=t.resumeSocket,this.clearAuth=t.clearAuth,this.logger=s.logger,this.refreshTokenLeewaySeconds=s.refreshTokenLeewaySeconds}async setConfig(e,t){this.resetAuthState(),this._logVerbose("pausing WS for auth token fetch"),this.pauseSocket();const s=await this.fetchTokenAndGuardAgainstRace(e,{forceRefreshToken:!1});s.isFromOutdatedConfig||(s.value?(this.setAuthState({state:"waitingForServerConfirmationOfCachedToken",config:{fetchToken:e,onAuthChange:t},hasRetried:!1}),this.authenticate(s.value)):(this.setAuthState({state:"initialRefetch",config:{fetchToken:e,onAuthChange:t}}),await this.refetchToken()),this._logVerbose("resuming WS after auth token fetch"),this.resumeSocket())}onTransition(e){if(this.syncState.isCurrentOrNewerAuthVersion(e.endVersion.identity)&&!(e.endVersion.identity<=e.startVersion.identity)){if(this.authState.state==="waitingForServerConfirmationOfCachedToken"){this._logVerbose("server confirmed auth token is valid"),this.refetchToken(),this.authState.config.onAuthChange(!0);return}this.authState.state==="waitingForServerConfirmationOfFreshToken"&&(this._logVerbose("server confirmed new auth token is valid"),this.scheduleTokenRefetch(this.authState.token),this.tokenConfirmationAttempts=0,this.authState.hadAuth||this.authState.config.onAuthChange(!0))}}onAuthError(e){if(e.authUpdateAttempted===!1&&(this.authState.state==="waitingForServerConfirmationOfFreshToken"||this.authState.state==="waitingForServerConfirmationOfCachedToken")){this._logVerbose("ignoring non-auth token expired error");return}const{baseVersion:t}=e;if(!this.syncState.isCurrentOrNewerAuthVersion(t+1)){this._logVerbose("ignoring auth error for previous auth attempt");return}this.tryToReauthenticate(e)}async tryToReauthenticate(e){if(this._logVerbose(`attempting to reauthenticate: ${e.error}`),this.authState.state==="noAuth"||this.authState.state==="waitingForServerConfirmationOfFreshToken"&&this.tokenConfirmationAttempts>=Ee){this.logger.error(`Failed to authenticate: "${e.error}", check your server auth config`),this.syncState.hasAuth()&&this.syncState.clearAuth(),this.authState.state!=="noAuth"&&this.setAndReportAuthFailed(this.authState.config.onAuthChange);return}this.authState.state==="waitingForServerConfirmationOfFreshToken"&&(this.tokenConfirmationAttempts++,this._logVerbose(`retrying reauthentication, ${Ee-this.tokenConfirmationAttempts} attempts remaining`)),await this.stopSocket();const t=await this.fetchTokenAndGuardAgainstRace(this.authState.config.fetchToken,{forceRefreshToken:!0});t.isFromOutdatedConfig||(t.value&&this.syncState.isNewAuth(t.value)?(this.authenticate(t.value),this.setAuthState({state:"waitingForServerConfirmationOfFreshToken",config:this.authState.config,token:t.value,hadAuth:this.authState.state==="notRefetching"||this.authState.state==="waitingForScheduledRefetch"})):(this._logVerbose("reauthentication failed, could not fetch a new token"),this.syncState.hasAuth()&&this.syncState.clearAuth(),this.setAndReportAuthFailed(this.authState.config.onAuthChange)),this.tryRestartSocket())}async refetchToken(){if(this.authState.state==="noAuth")return;this._logVerbose("refetching auth token");const e=await this.fetchTokenAndGuardAgainstRace(this.authState.config.fetchToken,{forceRefreshToken:!0});e.isFromOutdatedConfig||(e.value?this.syncState.isNewAuth(e.value)?(this.setAuthState({state:"waitingForServerConfirmationOfFreshToken",hadAuth:this.syncState.hasAuth(),token:e.value,config:this.authState.config}),this.authenticate(e.value)):this.setAuthState({state:"notRefetching",config:this.authState.config}):(this._logVerbose("refetching token failed"),this.syncState.hasAuth()&&this.clearAuth(),this.setAndReportAuthFailed(this.authState.config.onAuthChange)),this._logVerbose("restarting WS after auth token fetch (if currently stopped)"),this.tryRestartSocket())}scheduleTokenRefetch(e){if(this.authState.state==="noAuth")return;const t=this.decodeToken(e);if(!t){this.logger.error("Auth token is not a valid JWT, cannot refetch the token");return}const{iat:s,exp:r}=t;if(!s||!r){this.logger.error("Auth token does not have required fields, cannot refetch the token");return}const i=r-s;if(i<=2){this.logger.error("Auth token does not live long enough, cannot refetch the token");return}let o=Math.min(Tn,(i-this.refreshTokenLeewaySeconds)*1e3);o<=0&&(this.logger.warn(`Refetching auth token immediately, configured leeway ${this.refreshTokenLeewaySeconds}s is larger than the token's lifetime ${i}s`),o=0);const a=setTimeout(()=>{this._logVerbose("running scheduled token refetch"),this.refetchToken()},o);this.setAuthState({state:"waitingForScheduledRefetch",refetchTokenTimeoutId:a,config:this.authState.config}),this._logVerbose(`scheduled preemptive auth token refetching in ${o}ms`)}async fetchTokenAndGuardAgainstRace(e,t){const s=++this.configVersion;this._logVerbose(`fetching token with config version ${s}`);const r=await e(t);return this.configVersion!==s?(this._logVerbose(`stale config version, expected ${s}, got ${this.configVersion}`),{isFromOutdatedConfig:!0}):{isFromOutdatedConfig:!1,value:r}}stop(){this.resetAuthState(),this.configVersion++,this._logVerbose(`config version bumped to ${this.configVersion}`)}setAndReportAuthFailed(e){e(!1),this.resetAuthState()}resetAuthState(){this.setAuthState({state:"noAuth"})}setAuthState(e){const t=e.state==="waitingForServerConfirmationOfFreshToken"?{hadAuth:e.hadAuth,state:e.state,token:`...${e.token.slice(-7)}`}:{state:e.state};switch(this._logVerbose(`setting auth state to ${JSON.stringify(t)}`),e.state){case"waitingForScheduledRefetch":case"notRefetching":case"noAuth":this.tokenConfirmationAttempts=0;break}this.authState.state==="waitingForScheduledRefetch"&&(clearTimeout(this.authState.refetchTokenTimeoutId),this.syncState.markAuthCompletion()),this.authState=e}decodeToken(e){try{return tt(e)}catch(t){return this._logVerbose(`Error decoding token: ${t instanceof Error?t.message:"Unknown error"}`),null}}_logVerbose(e){this.logger.logVerbose(`${e} [v${this.configVersion}]`)}}const Cn=["convexClientConstructed","convexWebSocketOpen","convexFirstMessageReceived"];function _n(n,e){const t={sessionId:e};typeof performance>"u"||!performance.mark||performance.mark(n,{detail:t})}function qn(n){let e=n.name.slice(6);return e=e.charAt(0).toLowerCase()+e.slice(1),{name:e,startTime:n.startTime}}function An(n){if(typeof performance>"u"||!performance.getEntriesByName)return[];const e=[];for(const t of Cn){const s=performance.getEntriesByName(t).filter(r=>r.entryType==="mark").filter(r=>r.detail.sessionId===n);e.push(...s)}return e.map(qn)}var In=Object.defineProperty,$n=(n,e,t)=>e in n?In(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,g=(n,e,t)=>$n(n,typeof e!="symbol"?e+"":e,t);class Mn{constructor(e,t,s){if(g(this,"address"),g(this,"state"),g(this,"requestManager"),g(this,"webSocketManager"),g(this,"authenticationManager"),g(this,"remoteQuerySet"),g(this,"optimisticQueryResults"),g(this,"_transitionHandlerCounter",0),g(this,"_nextRequestId"),g(this,"_onTransitionFns",new Map),g(this,"_sessionId"),g(this,"firstMessageReceived",!1),g(this,"debug"),g(this,"logger"),g(this,"maxObservedTimestamp"),g(this,"connectionStateSubscribers",new Map),g(this,"nextConnectionStateSubscriberId",0),g(this,"_lastPublishedConnectionState"),g(this,"markConnectionStateDirty",()=>{Promise.resolve().then(()=>{const l=this.connectionState();if(JSON.stringify(l)!==JSON.stringify(this._lastPublishedConnectionState)){this._lastPublishedConnectionState=l;for(const d of this.connectionStateSubscribers.values())d(l)}})}),g(this,"mark",l=>{this.debug&&_n(l,this.sessionId)}),typeof e=="object")throw new Error("Passing a ClientConfig object is no longer supported. Pass the URL of the Convex deployment as a string directly.");(s==null?void 0:s.skipConvexDeploymentUrlCheck)!==!0&&Ct(e),s={...s};const r=s.authRefreshTokenLeewaySeconds??10;let i=s.webSocketConstructor;if(!i&&typeof WebSocket>"u")throw new Error("No WebSocket global variable defined! To use Convex in an environment without WebSocket try the HTTP client: https://docs.convex.dev/api/classes/browser.ConvexHttpClient");i=i||WebSocket,this.debug=s.reportDebugInfoToConvex??!1,this.address=e,this.logger=s.logger===!1?Ye({verbose:s.verbose??!1}):s.logger!==!0&&s.logger?s.logger:Xe({verbose:s.verbose??!1});const o=e.search("://");if(o===-1)throw new Error("Provided address was not an absolute URL.");const a=e.substring(o+3),u=e.substring(0,o);let c;if(u==="http")c="ws";else if(u==="https")c="wss";else throw new Error(`Unknown parent protocol ${u}`);const y=`${c}://${a}/api/${be}/sync`;this.state=new Ut,this.remoteQuerySet=new Ie(l=>this.state.queryPath(l),this.logger),this.requestManager=new Kt(this.logger,this.markConnectionStateDirty);const p=()=>{this.webSocketManager.pause(),this.state.pause()};this.authenticationManager=new Rn(this.state,{authenticate:l=>{const d=this.state.setAuth(l);return this.webSocketManager.sendMessage(d),d.baseVersion},stopSocket:()=>this.webSocketManager.stop(),tryRestartSocket:()=>this.webSocketManager.tryRestart(),pauseSocket:p,resumeSocket:()=>this.webSocketManager.resume(),clearAuth:()=>{this.clearAuth()}},{logger:this.logger,refreshTokenLeewaySeconds:r}),this.optimisticQueryResults=new Zt,this.addOnTransitionHandler(l=>{t(l.queries.map(d=>d.token))}),this._nextRequestId=0,this._sessionId=mn();const{unsavedChangesWarning:C}=s;if(typeof window>"u"||typeof window.addEventListener>"u"){if(C===!0)throw new Error("unsavedChangesWarning requested, but window.addEventListener not found! Remove {unsavedChangesWarning: true} from Convex client options.")}else C!==!1&&window.addEventListener("beforeunload",l=>{if(this.requestManager.hasIncompleteRequests()){l.preventDefault();const d="Are you sure you want to leave? Your changes may not be saved.";return(l||window.event).returnValue=d,d}});this.webSocketManager=new pn(y,{onOpen:l=>{this.mark("convexWebSocketOpen"),this.webSocketManager.sendMessage({...l,type:"Connect",sessionId:this._sessionId,maxObservedTimestamp:this.maxObservedTimestamp});const d=new Set(this.remoteQuerySet.remoteQueryResults().keys());this.remoteQuerySet=new Ie(Z=>this.state.queryPath(Z),this.logger);const[_,pe]=this.state.restart(d);pe&&this.webSocketManager.sendMessage(pe),this.webSocketManager.sendMessage(_);for(const Z of this.requestManager.restart())this.webSocketManager.sendMessage(Z)},onResume:()=>{const[l,d]=this.state.resume();d&&this.webSocketManager.sendMessage(d),l&&this.webSocketManager.sendMessage(l);for(const _ of this.requestManager.resume())this.webSocketManager.sendMessage(_)},onMessage:l=>{switch(this.firstMessageReceived||(this.firstMessageReceived=!0,this.mark("convexFirstMessageReceived"),this.reportMarks()),l.type){case"Transition":{this.observedTimestamp(l.endVersion.ts),this.authenticationManager.onTransition(l),this.remoteQuerySet.transition(l),this.state.transition(l);const d=this.requestManager.removeCompleted(this.remoteQuerySet.timestamp());this.notifyOnQueryResultChanges(d);break}case"MutationResponse":{l.success&&this.observedTimestamp(l.ts);const d=this.requestManager.onResponse(l);d!==null&&this.notifyOnQueryResultChanges(new Map([[d.requestId,d.result]]));break}case"ActionResponse":{this.requestManager.onResponse(l);break}case"AuthError":{this.authenticationManager.onAuthError(l);break}case"FatalError":{const d=Ft(this.logger,l.error);throw this.webSocketManager.terminate(),d}}return{hasSyncedPastLastReconnect:this.hasSyncedPastLastReconnect()}},onServerDisconnectError:s.onServerDisconnectError},i,this.logger,this.markConnectionStateDirty,this.debug),this.mark("convexClientConstructed"),s.expectAuth&&p()}hasSyncedPastLastReconnect(){return this.requestManager.hasSyncedPastLastReconnect()||this.state.hasSyncedPastLastReconnect()}observedTimestamp(e){(this.maxObservedTimestamp===void 0||this.maxObservedTimestamp.lessThanOrEqual(e))&&(this.maxObservedTimestamp=e)}getMaxObservedTimestamp(){return this.maxObservedTimestamp}notifyOnQueryResultChanges(e){const t=this.remoteQuerySet.remoteQueryResults(),s=new Map;for(const[i,o]of t){const a=this.state.queryToken(i);if(a!==null){const u={result:o,udfPath:this.state.queryPath(i),args:this.state.queryArgs(i)};s.set(a,u)}}const r=this.optimisticQueryResults.ingestQueryResultsFromServer(s,new Set(e.keys()));this.handleTransition({queries:r.map(i=>{const o=this.optimisticQueryResults.rawQueryResult(i);return{token:i,modification:{kind:"Updated",result:o}}}),reflectedMutations:Array.from(e).map(([i,o])=>({requestId:i,result:o})),timestamp:this.remoteQuerySet.timestamp()})}handleTransition(e){for(const t of this._onTransitionFns.values())t(e)}addOnTransitionHandler(e){const t=this._transitionHandlerCounter++;return this._onTransitionFns.set(t,e),()=>this._onTransitionFns.delete(t)}getCurrentAuthClaims(){const e=this.state.getAuth();let t={};if(e&&e.tokenType==="User")try{t=e?tt(e.value):{}}catch{t={}}else return;return{token:e.value,decoded:t}}setAuth(e,t){this.authenticationManager.setConfig(e,t)}hasAuth(){return this.state.hasAuth()}setAdminAuth(e,t){const s=this.state.setAdminAuth(e,t);this.webSocketManager.sendMessage(s)}clearAuth(){const e=this.state.clearAuth();this.webSocketManager.sendMessage(e)}subscribe(e,t,s){const r=R(t),{modification:i,queryToken:o,unsubscribe:a}=this.state.subscribe(e,r,s==null?void 0:s.journal,s==null?void 0:s.componentPath);return i!==null&&this.webSocketManager.sendMessage(i),{queryToken:o,unsubscribe:()=>{const u=a();u&&this.webSocketManager.sendMessage(u)}}}localQueryResult(e,t){const s=R(t),r=A(e,s);return this.optimisticQueryResults.queryResult(r)}localQueryResultByToken(e){return this.optimisticQueryResults.queryResult(e)}hasLocalQueryResultByToken(e){return this.optimisticQueryResults.hasQueryResult(e)}localQueryLogs(e,t){const s=R(t),r=A(e,s);return this.optimisticQueryResults.queryLogs(r)}queryJournal(e,t){const s=R(t),r=A(e,s);return this.state.queryJournal(r)}connectionState(){const e=this.webSocketManager.connectionState();return{hasInflightRequests:this.requestManager.hasInflightRequests(),isWebSocketConnected:e.isConnected,hasEverConnected:e.hasEverConnected,connectionCount:e.connectionCount,connectionRetries:e.connectionRetries,timeOfOldestInflightRequest:this.requestManager.timeOfOldestInflightRequest(),inflightMutations:this.requestManager.inflightMutations(),inflightActions:this.requestManager.inflightActions()}}subscribeToConnectionState(e){const t=this.nextConnectionStateSubscriberId++;return this.connectionStateSubscribers.set(t,e),()=>{this.connectionStateSubscribers.delete(t)}}async mutation(e,t,s){const r=await this.mutationInternal(e,t,s);if(!r.success)throw r.errorData!==void 0?he(r,new ce(O("mutation",e,r))):new Error(O("mutation",e,r));return r.value}async mutationInternal(e,t,s,r){const{mutationPromise:i}=this.enqueueMutation(e,t,s,r);return i}enqueueMutation(e,t,s,r){const i=R(t);this.tryReportLongDisconnect();const o=this.nextRequestId;if(this._nextRequestId++,s!==void 0){const y=s.optimisticUpdate;if(y!==void 0){const p=d=>{y(d,i)instanceof Promise&&this.logger.warn("Optimistic update handler returned a Promise. Optimistic updates should be synchronous.")},l=this.optimisticQueryResults.applyOptimisticUpdate(p,o).map(d=>{const _=this.localQueryResultByToken(d);return{token:d,modification:{kind:"Updated",result:_===void 0?void 0:{success:!0,value:_,logLines:[]}}}});this.handleTransition({queries:l,reflectedMutations:[],timestamp:this.remoteQuerySet.timestamp()})}}const a={type:"Mutation",requestId:o,udfPath:e,componentPath:r,args:[I(i)]},u=this.webSocketManager.sendMessage(a),c=this.requestManager.request(a,u);return{requestId:o,mutationPromise:c}}async action(e,t){const s=await this.actionInternal(e,t);if(!s.success)throw s.errorData!==void 0?he(s,new ce(O("action",e,s))):new Error(O("action",e,s));return s.value}async actionInternal(e,t,s){const r=R(t),i=this.nextRequestId;this._nextRequestId++,this.tryReportLongDisconnect();const o={type:"Action",requestId:i,udfPath:e,componentPath:s,args:[I(r)]},a=this.webSocketManager.sendMessage(o);return this.requestManager.request(o,a)}async close(){return this.authenticationManager.stop(),this.webSocketManager.terminate()}get url(){return this.address}get nextRequestId(){return this._nextRequestId}get sessionId(){return this._sessionId}reportMarks(){if(this.debug){const e=An(this.sessionId);this.webSocketManager.sendMessage({type:"Event",eventType:"ClientConnect",event:e})}}tryReportLongDisconnect(){if(!this.debug)return;const e=this.connectionState().timeOfOldestInflightRequest;if(e===null||Date.now()-e.getTime()<=60*1e3)return;const t=`${this.address}/api/debug_event`;fetch(t,{method:"POST",headers:{"Content-Type":"application/json","Convex-Client":`npm-${be}`},body:JSON.stringify({event:"LongWebsocketDisconnect"})}).then(s=>{s.ok||this.logger.warn("Analytics request failed with response:",s.body)}).catch(s=>{this.logger.warn("Analytics response failed with error:",s)})}}function oe(n){if(typeof n!="object"||n===null||!Array.isArray(n.page)||typeof n.isDone!="boolean"||typeof n.continueCursor!="string")throw new Error(`Not a valid paginated query result: ${n==null?void 0:n.toString()}`);return n}var En=Object.defineProperty,On=(n,e,t)=>e in n?En(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Oe=(n,e,t)=>On(n,typeof e!="symbol"?e+"":e,t);class Pn{constructor(e,t){this.client=e,this.onTransition=t,Oe(this,"paginatedQuerySet",new Map),Oe(this,"lastTransitionTs"),this.lastTransitionTs=w.fromNumber(0),this.client.addOnTransitionHandler(s=>this.onBaseTransition(s))}subscribe(e,t,s){const r=$(e),i=_e(r,t,s),o=()=>this.removePaginatedQuerySubscriber(i),a=this.paginatedQuerySet.get(i);return a?(a.numSubscribers+=1,{paginatedQueryToken:i,unsubscribe:o}):(this.paginatedQuerySet.set(i,{token:i,canonicalizedUdfPath:r,args:t,numSubscribers:1,options:{initialNumItems:s.initialNumItems},nextPageKey:0,pageKeys:[],pageKeyToQuery:new Map,ongoingSplits:new Map,skip:!1,id:s.id}),this.addPageToPaginatedQuery(i,null,s.initialNumItems),{paginatedQueryToken:i,unsubscribe:o})}localQueryResult(e,t,s){const r=$(e),i=_e(r,t,s);return this.localQueryResultByToken(i)}localQueryResultByToken(e){const t=this.paginatedQuerySet.get(e);if(!t)return;const s=this.activePageQueryTokens(t);if(s.length===0)return{results:[],status:"LoadingFirstPage",loadMore:u=>this.loadMoreOfPaginatedQuery(e,u)};let r=[],i=!1,o=!1;for(const u of s){const c=this.client.localQueryResultByToken(u);if(c===void 0){i=!0,o=!1;continue}const y=oe(c);r=r.concat(y.page),o=!!y.isDone}let a;return i?a=r.length===0?"LoadingFirstPage":"LoadingMore":o?a="Exhausted":a="CanLoadMore",{results:r,status:a,loadMore:u=>this.loadMoreOfPaginatedQuery(e,u)}}onBaseTransition(e){const t=e.queries.map(o=>o.token),s=this.queriesContainingTokens(t);let r=[];s.length>0&&(this.processPaginatedQuerySplits(s,o=>this.client.localQueryResultByToken(o)),r=s.map(o=>({token:o,modification:{kind:"Updated",result:this.localQueryResultByToken(o)}})));const i={...e,paginatedQueries:r};this.onTransition(i)}loadMoreOfPaginatedQuery(e,t){this.mustGetPaginatedQuery(e);const s=this.queryTokenForLastPageOfPaginatedQuery(e),r=this.client.localQueryResultByToken(s);if(!r)return!1;const i=oe(r);if(i.isDone)return!1;this.addPageToPaginatedQuery(e,i.continueCursor,t);const o={timestamp:this.lastTransitionTs,reflectedMutations:[],queries:[],paginatedQueries:[{token:e,modification:{kind:"Updated",result:this.localQueryResultByToken(e)}}]};return this.onTransition(o),!0}queriesContainingTokens(e){if(e.length===0)return[];const t=[],s=new Set(e);for(const[r,i]of this.paginatedQuerySet)for(const o of this.allQueryTokens(i))if(s.has(o)){t.push(r);break}return t}processPaginatedQuerySplits(e,t){for(const s of e){const r=this.mustGetPaginatedQuery(s),{ongoingSplits:i,pageKeyToQuery:o,pageKeys:a}=r;for(const[u,[c,y]]of i)t(o.get(c).queryToken)!==void 0&&t(o.get(y).queryToken)!==void 0&&this.completePaginatedQuerySplit(r,u,c,y);for(const u of a){if(i.has(u))continue;const c=o.get(u).queryToken,y=t(c);if(!y)continue;const p=oe(y);p.splitCursor&&(p.pageStatus==="SplitRecommended"||p.pageStatus==="SplitRequired"||p.page.length>r.options.initialNumItems*2)&&this.splitPaginatedQueryPage(r,u,p.splitCursor,p.continueCursor)}}}splitPaginatedQueryPage(e,t,s,r){const i=e.nextPageKey++,o=e.nextPageKey++,a={cursor:r,numItems:e.options.initialNumItems,id:e.id},u=this.client.subscribe(e.canonicalizedUdfPath,{...e.args,paginationOpts:{...a,cursor:null,endCursor:s}});e.pageKeyToQuery.set(i,u);const c=this.client.subscribe(e.canonicalizedUdfPath,{...e.args,paginationOpts:{...a,cursor:s,endCursor:r}});e.pageKeyToQuery.set(o,c),e.ongoingSplits.set(t,[i,o])}addPageToPaginatedQuery(e,t,s){const r=this.mustGetPaginatedQuery(e),i=r.nextPageKey++,o={cursor:t,numItems:s,id:r.id},a={...r.args,paginationOpts:o},u=this.client.subscribe(r.canonicalizedUdfPath,a);return r.pageKeys.push(i),r.pageKeyToQuery.set(i,u),u}removePaginatedQuerySubscriber(e){const t=this.paginatedQuerySet.get(e);if(t&&(t.numSubscribers-=1,!(t.numSubscribers>0))){for(const s of t.pageKeyToQuery.values())s.unsubscribe();this.paginatedQuerySet.delete(e)}}completePaginatedQuerySplit(e,t,s,r){const i=e.pageKeyToQuery.get(t);e.pageKeyToQuery.delete(t);const o=e.pageKeys.indexOf(t);e.pageKeys.splice(o,1,s,r),e.ongoingSplits.delete(t),i.unsubscribe()}activePageQueryTokens(e){return e.pageKeys.map(t=>e.pageKeyToQuery.get(t).queryToken)}allQueryTokens(e){return Array.from(e.pageKeyToQuery.values()).map(t=>t.queryToken)}queryTokenForLastPageOfPaginatedQuery(e){const t=this.mustGetPaginatedQuery(e),s=t.pageKeys[t.pageKeys.length-1];if(s===void 0)throw new Error(`No pages for paginated query ${e}`);return t.pageKeyToQuery.get(s).queryToken}mustGetPaginatedQuery(e){const t=this.paginatedQuerySet.get(e);if(!t)throw new Error("paginated query no longer exists for token "+e);return t}}var xn=Object.defineProperty,Qn=(n,e,t)=>e in n?xn(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,T=(n,e,t)=>Qn(n,typeof e!="symbol"?e+"":e,t);const Ln=5e3;if(typeof Ue>"u")throw new Error("Required dependency 'react' not found");class Vn{constructor(e,t){if(T(this,"address"),T(this,"cachedSync"),T(this,"cachedPaginatedQueryClient"),T(this,"listeners"),T(this,"options"),T(this,"closed",!1),T(this,"_logger"),T(this,"adminAuth"),T(this,"fakeUserIdentity"),e===void 0)throw new Error("No address provided to ConvexReactClient.\nIf trying to deploy to production, make sure to follow all the instructions found at https://docs.convex.dev/production/hosting/\nIf running locally, make sure to run `convex dev` and ensure the .env.local file is populated.");if(typeof e!="string")throw new Error(`ConvexReactClient requires a URL like 'https://happy-otter-123.convex.cloud', received something of type ${typeof e} instead.`);if(!e.includes("://"))throw new Error("Provided address was not an absolute URL.");this.address=e,this.listeners=new Map,this._logger=(t==null?void 0:t.logger)===!1?Ye({verbose:(t==null?void 0:t.verbose)??!1}):(t==null?void 0:t.logger)!==!0&&(t!=null&&t.logger)?t.logger:Xe({verbose:(t==null?void 0:t.verbose)??!1}),this.options={...t,logger:this._logger}}get url(){return this.address}get sync(){if(this.closed)throw new Error("ConvexReactClient has already been closed.");return this.cachedSync?this.cachedSync:(this.cachedSync=new Mn(this.address,()=>{},this.options),this.adminAuth&&this.cachedSync.setAdminAuth(this.adminAuth,this.fakeUserIdentity),this.cachedPaginatedQueryClient=new Pn(this.cachedSync,e=>this.handleTransition(e)),this.cachedSync)}get paginatedQueryClient(){if(this.sync,this.cachedPaginatedQueryClient)return this.cachedPaginatedQueryClient;throw new Error("Should already be instantiated")}setAuth(e,t){if(typeof e=="string")throw new Error("Passing a string to ConvexReactClient.setAuth is no longer supported, please upgrade to passing in an async function to handle reauthentication.");this.sync.setAuth(e,t??(()=>{}))}clearAuth(){this.sync.clearAuth()}setAdminAuth(e,t){if(this.adminAuth=e,this.fakeUserIdentity=t,this.closed)throw new Error("ConvexReactClient has already been closed.");this.cachedSync&&this.sync.setAdminAuth(e,t)}watchQuery(e,...t){const[s,r]=t,i=q(e);return{onUpdate:o=>{const{queryToken:a,unsubscribe:u}=this.sync.subscribe(i,s,r),c=this.listeners.get(a);return c!==void 0?c.add(o):this.listeners.set(a,new Set([o])),()=>{if(this.closed)return;const y=this.listeners.get(a);y.delete(o),y.size===0&&this.listeners.delete(a),u()}},localQueryResult:()=>{if(this.cachedSync)return this.cachedSync.localQueryResult(i,s)},localQueryLogs:()=>{if(this.cachedSync)return this.cachedSync.localQueryLogs(i,s)},journal:()=>{if(this.cachedSync)return this.cachedSync.queryJournal(i,s)}}}prewarmQuery(e){const t=e.extendSubscriptionFor??Ln,r=this.watchQuery(e.query,e.args||{}).onUpdate(()=>{});setTimeout(r,t)}watchPaginatedQuery(e,t,s){const r=q(e);return{onUpdate:i=>{const{paginatedQueryToken:o,unsubscribe:a}=this.paginatedQueryClient.subscribe(r,t||{},s),u=this.listeners.get(o);return u!==void 0?u.add(i):this.listeners.set(o,new Set([i])),()=>{if(this.closed)return;const c=this.listeners.get(o);c.delete(i),c.size===0&&this.listeners.delete(o),a()}},localQueryResult:()=>this.paginatedQueryClient.localQueryResult(r,t,s)}}mutation(e,...t){const[s,r]=t,i=q(e);return this.sync.mutation(i,s,r)}action(e,...t){const s=q(e);return this.sync.action(s,...t)}query(e,...t){const s=this.watchQuery(e,...t),r=s.localQueryResult();return r!==void 0?Promise.resolve(r):new Promise((i,o)=>{const a=s.onUpdate(()=>{a();try{i(s.localQueryResult())}catch(u){o(u)}})})}connectionState(){return this.sync.connectionState()}subscribeToConnectionState(e){return this.sync.subscribeToConnectionState(e)}get logger(){return this._logger}async close(){if(this.closed=!0,this.listeners=new Map,this.cachedPaginatedQueryClient&&(this.cachedPaginatedQueryClient=void 0),this.cachedSync){const e=this.cachedSync;this.cachedSync=void 0,await e.close()}}handleTransition(e){const t=e.queries.map(r=>r.token),s=e.paginatedQueries.map(r=>r.token);this.transition([...t,...s])}transition(e){for(const t of e){const s=this.listeners.get(t);if(s)for(const r of s)r()}}}Ue.createContext(void 0);export{Vn as C,Ue as R,wt as r};
