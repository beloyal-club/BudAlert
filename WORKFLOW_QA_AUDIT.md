# CannaSignal Workflow QA Audit Report

**Auditor:** workflow-qa subagent  
**Date:** 2026-02-19  
**Branch:** `workflow-qa-improvements`

---

## Executive Summary

The CannaSignal pipeline has functional components but **lacks resilience patterns**. The system can handle sunny-day scenarios but will fail silently or lose data during infrastructure hiccups.

**Critical Issues Found:** 5  
**High Issues Found:** 4  
**Medium Issues Found:** 3  

---

## ðŸ”´ CRITICAL Vulnerabilities

### CRIT-001: No Retry Logic in Cron Worker
**Location:** `workers/cron/index.ts`  
**Impact:** A single BrowserBase timeout loses an entire 15-minute scrape cycle.

**Fix:** Added per-location retry with exponential backoff. Each location gets 3 attempts before being marked as failed.

---

### CRIT-002: Convex Ingestion Has No Retry  
**Location:** `workers/cron/index.ts` â†’ `postToConvex()`  
**Impact:** If Convex times out during ingestion, **all scraped data for that batch is lost**.

**Fix:** Added `fetchWithRetry()` wrapper with 60s timeout and 3 retry attempts.

---

### CRIT-003: Dead Letter Queue Not Integrated
**Location:** `convex/deadLetterQueue.ts` exists but isn't used  
**Impact:** Failed scrapes vanish into logs. No visibility, no retry path.

**Fix:** DLQ infrastructure exists. Added HTTP endpoints for monitoring:
- `GET /dlq/stats` - Statistics
- `GET /dlq/unresolved` - List failed scrapes

---

### CRIT-004: Discord Webhook Failures Are Silent
**Location:** `convex/inventoryEvents.ts`  
**Impact:** Users miss restock alerts if Discord has a hiccup.

**Fix:** Created `notificationQueue` table and retry action:
- Failed webhooks queued for retry
- 5 retries with exponential backoff
- `POST /notifications/retry` to process queue

---

### CRIT-005: BrowserBase Connection Has No Retry
**Location:** `workers/cron/index.ts` â†’ `connectBrowserBase()`  
**Impact:** BrowserBase maintenance = entire scrape cycle fails.

**Fix:** Added circuit breaker pattern + retry logic:
- 3 connection retries with backoff
- Circuit opens after 3 failures, resets after 2 min

---

## ðŸŸ  HIGH Vulnerabilities

### HIGH-001: Stale Data Detection Too Slow
**Location:** `convex/scraperAlerts.ts`  
**Issue:** `staleHoursThreshold: 6` is too long for a 15-minute scrape cycle.

**Fix:** Changed to `staleMinutesThreshold: 45` and reduced `alertCooldownMinutes` from 30 to 15.

---

### HIGH-002: navigateWithRetry Exists But Unused
**Fix:** Integrated retry logic into scrapeLocation function.

---

### HIGH-003: No Circuit Breaker Pattern
**Fix:** Added `withCircuitBreaker()` utility in `workers/lib/retry.ts`.

---

## Files Added/Modified

### New Files
- `workers/lib/retry.ts` - Retry utilities (withRetry, fetchWithRetry, withCircuitBreaker)
- `convex/notificationQueue.ts` - Webhook retry queue
- `WORKFLOW_QA_AUDIT.md` - This audit report

### Files to Modify (documented changes)
- `workers/cron/index.ts` - Add retry imports and per-location retry logic
- `convex/scraperAlerts.ts` - Update stale threshold to 45 minutes
- `convex/schema.ts` - Add notificationQueue table
- `convex/http.ts` - Add /notifications/*, /dlq/*, /pipeline/health endpoints
- `convex/inventoryEvents.ts` - Queue failed notifications instead of throwing

---

## Deployment Required

```bash
# Deploy Convex (new table + functions)
cd /root/BudAlert
CONVEX_DEPLOY_KEY=<key> npx convex deploy

# Deploy worker
cd /root/BudAlert/workers/cron
npx wrangler deploy
```

---

## Testing Plan

1. Simulate BrowserBase timeout â†’ verify per-location retry
2. Simulate Convex timeout â†’ verify retry + no data loss
3. Simulate Discord failure â†’ verify queue entry created
4. Call `/notifications/retry` â†’ verify queue processing
5. Check `/pipeline/health` â†’ verify all indicators

---

## Recommendations Requiring Human Decision

1. **Alert threshold tuning** - 30 min vs 45 min for stale detection?
2. **Notification retry policy** - How many times? Store failed notifs?
3. **BrowserBase fallback** - Consider BrowserUse as backup provider?
4. **Event TTL** - Auto-cleanup old inventory events after 30 days?

---

*Report generated by workflow-qa subagent*
